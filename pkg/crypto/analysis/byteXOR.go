package analysis

import (
	"math"

	"gonum.org/v1/gonum/stat/distuv"

	"gonum.org/v1/gonum/stat"

	"github.com/eseymour/cryptopals/pkg/crypto/xor"
)

// BreakXOREncryptByteKey finds the byte key whose plaintext best matches the
// distribution of ASCII byte values of English text. PValue represents the
// likelihood that the plaintext fits the distribution using a Chi Squared test.
func BreakXOREncryptByteKey(ciphertext []byte) (key byte, pValue float64) {
	chi2 := math.Inf(0)

	var expectedFreqs [256]float64
	for i, p := range englishDist {
		expectedFreqs[i] = p * float64(len(ciphertext))
	}

	plaintext := make([]byte, len(ciphertext))
	for candidate := 0; candidate <= math.MaxUint8; candidate++ {
		xor.EncryptByteKey(plaintext, ciphertext, byte(candidate))

		var candidateFreqs [256]float64
		for _, b := range plaintext {
			candidateFreqs[b]++
		}

		candidateChi2 := stat.ChiSquare(candidateFreqs[:], expectedFreqs[:])
		if candidateChi2 < chi2 {
			chi2 = candidateChi2
			key = byte(candidate)
		}
	}

	pValue = 1 - englishChi2Dist.CDF(chi2)
	return key, pValue
}

// A distuv.ChiSquared distribution used to calculate a CDF for calculating
// p-values for a Chi Squared test.
var englishChi2Dist = distuv.ChiSquared{K: 255}

// English language byte distribution from local fortune files using the program
// github.com/eseymour/goutils/cmd/fortuneStats. Generated using the Homebrew
// version of fortune.
var englishDist = [256]float64{
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 2.4490410223276844e-05, 0.0001384821378079836,
	0.009587772962319946, 0.021125427858598604, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 0.15991436371465198,
	0.0012445581195283414, 0.004958640149934745, 0.0002849793189617669,
	5.076194119006473e-05, 3.5622414870220865e-05, 5.9667544907619945e-05,
	0.004365081662159689, 0.0007525235141334157, 0.0007623196782227265,
	0.0002956660434228332, 2.5380970595032366e-05, 0.010131460069276692,
	0.008456316010004555, 0.013214580076294308, 0.000258707787994979,
	0.0005650605558788785, 0.0008660699615322448, 0.0004377104227178389,
	0.00036958255427854144, 0.00026449643041138993, 0.00031525837160145464,
	0.00021061752792018084, 0.00022442121368239143, 0.00030145468583924406,
	0.00038071455892548547, 0.001619484036037416, 0.0005281023004510243,
	3.250545356907654e-05, 0.0002431229814892574, 6.233922602288651e-05,
	0.0010548687603444153, 4.007521672899847e-05, 0.0035373057966129316,
	0.0018919955097946057, 0.0019449838519140592, 0.0017290229617633452,
	0.002008658918494579, 0.0011964678594535432, 0.0012481203610153636,
	0.0017112117543282347, 0.0048370786591901156, 0.0007235803020513613,
	0.000545468227700257, 0.0017285776815774674, 0.0019445385717281813,
	0.0017000797496812907, 0.0016956269478225132, 0.0014680887728389773,
	0.00024802106353391274, 0.0016074614710187166, 0.0028698307979821685,
	0.004423858646695553, 0.0006884031673670182, 0.0004105483313792955,
	0.002190333234332705, 0.00015184054338431642, 0.0010250349878906054,
	8.104099382975246e-05, 0.0001807837554663709, 0.00014338021985263897,
	0.00018033847528049312, 2.5826250780910127e-05, 0.0005481399088155235,
	7.925987308624141e-05, 0.05652653847643822, 0.010843017806309353,
	0.018777465438465174, 0.025425943893806018, 0.08930183183815668,
	0.014704932858427172, 0.015090545499397314, 0.03650896772030349,
	0.04881740261833655, 0.0008843264491532329, 0.006789186994078219,
	0.031481754421743564, 0.018190140873292408, 0.05105449027218642,
	0.059071314738729626, 0.013006634229489392, 0.0006416487478498533,
	0.04392733561702698, 0.04495237060491759, 0.06295549380014133,
	0.02260242223515514, 0.007701120814755873, 0.013918568050167047,
	0.0014115381892325018, 0.016621418778445054, 0.0006683655590025189,
	7.124482974044172e-06, 5.476946286296458e-05, 5.343362230533129e-06,
	2.0482888550376995e-05, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	2.0482888550376995e-05, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	2.0482888550376995e-05, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	2.0482888550376995e-05, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	2.0482888550376995e-05, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	2.0482888550376995e-05, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	2.0482888550376995e-05, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	2.0482888550376995e-05, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	2.0482888550376995e-05, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07, 4.4528018587776077e-07, 4.4528018587776077e-07,
	4.4528018587776077e-07,
}
